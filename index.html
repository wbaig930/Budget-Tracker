import React, { useState, useMemo, useEffect, useCallback } from 'react';
import { PieChart, Pie, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, Legend } from 'recharts';
import { Home, TrendingUp, TrendingDown, Clock, Layers, DollarSign, Plus, X } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, onSnapshot, addDoc } from 'firebase/firestore';

// --- Global Configuration ---
const CATEGORY_COLORS = {
  Food: '#FF8042', 
  Rent: '#0088FE', 
  Salary: '#00C49F', 
  Shopping: '#FFBB28', 
  Transport: '#8884d8', 
  Utilities: '#E91E63', 
  Investment: '#2196F3', 
  Misc: '#6B7280', // Default color for new categories
};
const ALL_CATEGORIES = ['Food', 'Rent', 'Shopping', 'Transport', 'Utilities', 'Investment', 'Salary', 'Misc'];

// Helper to safely access global variables
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Utility Components ---

const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
  }).format(amount);
};

const StatsCard = ({ title, value, icon: Icon, colorClass }) => (
  <div className="flex flex-col p-5 bg-gray-800 rounded-xl shadow-lg transition duration-300 hover:ring-2 hover:ring-indigo-500/50">
    <div className="flex items-center justify-between">
      <p className="text-sm font-medium text-gray-400 uppercase">{title}</p>
      <Icon className={`w-5 h-5 ${colorClass}`} />
    </div>
    <div className="mt-1 text-2xl font-bold text-gray-100">
      {formatCurrency(value)}
    </div>
  </div>
);

const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    const data = payload[0].payload;
    const isBarChart = data.month;
    const value = isBarChart ? payload[0].value : data.value;
    const name = isBarChart ? payload[0].dataKey : data.name;

    return (
      <div className="p-3 bg-gray-700/90 backdrop-blur-sm border border-gray-600 rounded-lg shadow-xl text-gray-100 text-sm">
        {isBarChart ? (
          <>
            <p className="font-bold mb-1">{label}</p>
            <p className={`text-sm ${name === 'income' ? 'text-green-400' : 'text-red-400'}`}>
              {name.charAt(0).toUpperCase() + name.slice(1)}: {formatCurrency(value)}
            </p>
          </>
        ) : (
          <>
            <p className="font-bold mb-1">{name}</p>
            <p className="text-sm text-white">Amount: {formatCurrency(value)}</p>
          </>
        )}
      </div>
    );
  }
  return null;
};

// --- Transaction Components ---

const TransactionList = ({ transactions, isLoading }) => (
  <div className="bg-gray-800 p-6 rounded-xl h-full flex flex-col min-h-[300px]">
    <h2 className="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-700/50 pb-2 flex items-center">
      <Clock className="w-5 h-5 mr-2 text-indigo-400" /> Recent Transactions
    </h2>
    {isLoading ? (
      <div className="flex-grow flex items-center justify-center text-gray-400">Loading transactions...</div>
    ) : transactions.length === 0 ? (
      <div className="flex-grow flex items-center justify-center text-gray-500 italic">No transactions recorded yet. Add one to see your ledger!</div>
    ) : (
      <div className="space-y-3 overflow-y-auto custom-scrollbar pr-2">
        {transactions.map(t => {
          const isIncome = t.type === 'Income';
          const amountClass = isIncome ? 'text-green-400' : 'text-red-400';
          const categoryColor = CATEGORY_COLORS[t.category] || CATEGORY_COLORS.Misc;

          return (
            <div
              key={t.id}
              className="flex justify-between items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 border border-gray-700/50"
            >
              <div className="flex items-center">
                <span 
                  className="w-2 h-2 rounded-full mr-3"
                  style={{ backgroundColor: categoryColor }}
                ></span>
                <div>
                  <p className="text-gray-100 font-medium">{t.description}</p>
                  <p className="text-xs text-gray-400">{t.category} &bull; {t.date}</p>
                </div>
              </div>
              <p className={`font-bold text-lg ${amountClass}`}>
                {isIncome ? '+' : '-'} {formatCurrency(t.amount)}
              </p>
            </div>
          );
        })}
      </div>
    )}
  </div>
);

// --- Chart Components ---

const PieChartComponent = ({ data }) => (
  <div className="bg-gray-800 p-6 rounded-xl flex flex-col h-full">
    <h2 className="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-700/50 pb-2 flex items-center">
      <Layers className="w-5 h-5 mr-2 text-indigo-400" /> Expense Breakdown (All Time)
    </h2>
    <div className='flex-grow min-h-[250px]'>
      <ResponsiveContainer width="100%" height="100%">
        <PieChart>
          <Pie
            data={data}
            dataKey="value"
            nameKey="name"
            cx="50%"
            cy="50%"
            outerRadius={80}
            fill="#8884d8"
            labelLine={false}
            stroke="#1F2937" 
            label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}
          >
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={CATEGORY_COLORS[entry.name] || CATEGORY_COLORS.Misc} />
            ))}
          </Pie>
          <Tooltip content={<CustomTooltip />} />
          <Legend 
            wrapperStyle={{ paddingTop: '10px' }}
            formatter={(value) => <span className="text-gray-300 text-sm">{value}</span>}
          />
        </PieChart>
      </ResponsiveContainer>
    </div>
  </div>
);

const BarChartComponent = ({ data }) => (
  <div className="bg-gray-800 p-6 rounded-xl col-span-1 lg:col-span-2">
    <h2 className="text-xl font-semibold mb-6 text-gray-100 border-b border-gray-700/50 pb-2 flex items-center">
      <DollarSign className="w-5 h-5 mr-2 text-indigo-400" /> Monthly Cash Flow
    </h2>
    <div className='h-72'>
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={data}
          margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
        >
          <XAxis dataKey="month" stroke="#4B5563" className="text-xs" />
          <YAxis stroke="#4B5563" className="text-xs" tickFormatter={val => `$${val / 1000}k`} />
          <Tooltip content={<CustomTooltip />} />
          <Legend formatter={(value) => <span className="text-gray-300 text-sm">{value.toUpperCase()}</span>} />
          
          <Bar dataKey="income" fill={CATEGORY_COLORS.Salary} name="Income" radius={[10, 10, 0, 0]} />
          <Bar dataKey="expense" fill={CATEGORY_COLORS.Transport} name="Expense" radius={[10, 10, 0, 0]} />
        </BarChart>
      </ResponsiveContainer>
    </div>
  </div>
);

// --- New Transaction Modal ---

const AddTransactionModal = ({ isVisible, onClose, db, userId }) => {
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('Food');
  const [type, setType] = useState('Expense');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!amount || !description || !category || !type) {
      setError('All fields are required.');
      return;
    }
    if (isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
      setError('Please enter a valid amount.');
      return;
    }

    setLoading(true);
    setError(null);
    const transaction = {
      amount: parseFloat(amount),
      description,
      category,
      type,
      date: new Date().toISOString().substring(0, 10), // YYYY-MM-DD format
      createdAt: new Date(),
    };

    const path = `/artifacts/${appId}/users/${userId}/transactions`;
    try {
      await addDoc(collection(db, path), transaction);
      // Reset form on success
      setAmount('');
      setDescription('');
      setCategory('Food');
      setType('Expense');
      onClose();
    } catch (err) {
      console.error("Error adding document: ", err);
      setError('Failed to save transaction. Check console for details.');
    } finally {
      setLoading(false);
    }
  };

  if (!isVisible) return null;

  return (
    <div className="fixed inset-0 bg-black/75 z-50 flex items-center justify-center p-4">
      <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-indigo-700/50">
        <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
          <h3 className="text-2xl font-bold text-gray-100">Add New Transaction</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-100 p-1 rounded-full transition">
            <X className="w-6 h-6" />
          </button>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          
          <div>
            <label className="block text-sm font-medium text-gray-400 mb-1">Type</label>
            <div className="flex space-x-4">
              <button
                type="button"
                onClick={() => setType('Income')}
                className={`flex-1 py-2 rounded-lg font-semibold transition ${type === 'Income' 
                  ? 'bg-green-600 text-white shadow-lg' 
                  : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
              >
                Income
              </button>
              <button
                type="button"
                onClick={() => setType('Expense')}
                className={`flex-1 py-2 rounded-lg font-semibold transition ${type === 'Expense' 
                  ? 'bg-red-600 text-white shadow-lg' 
                  : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
              >
                Expense
              </button>
            </div>
          </div>
          
          <div>
            <label htmlFor="amount" className="block text-sm font-medium text-gray-400 mb-1">Amount ($)</label>
            <input
              id="amount"
              type="number"
              step="0.01"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="e.g., 150.00"
            />
          </div>

          <div>
            <label htmlFor="description" className="block text-sm font-medium text-gray-400 mb-1">Description</label>
            <input
              id="description"
              type="text"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="e.g., Monthly Rent"
            />
          </div>

          <div>
            <label htmlFor="category" className="block text-sm font-medium text-gray-400 mb-1">Category</label>
            <select
              id="category"
              value={category}
              onChange={(e) => setCategory(e.target.value)}
              className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-indigo-500 focus:border-indigo-500"
            >
              {ALL_CATEGORIES.map(cat => (
                <option key={cat} value={cat}>{cat}</option>
              ))}
            </select>
          </div>

          {error && <p className="text-red-400 text-sm">{error}</p>}
          
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 disabled:opacity-50 flex items-center justify-center"
          >
            {loading ? 'Saving...' : 'Save Transaction'}
          </button>
        </form>
      </div>
    </div>
  );
};

// --- Main Application Component ---

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // 1. Firebase Initialization and Authentication
  useEffect(() => {
    if (!Object.keys(firebaseConfig).length) {
        console.error("Firebase configuration is missing.");
        setIsAuthReady(true);
        setIsLoading(false);
        return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);
      setDb(firestore);
      setAuth(firebaseAuth);

      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
          setIsAuthReady(true);
        } else {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(firebaseAuth, initialAuthToken);
            } else {
              const anonUser = await signInAnonymously(firebaseAuth);
              setUserId(anonUser.user.uid);
            }
          } catch (e) {
            console.error("Authentication failed:", e);
            // Fallback for environments where auth fails but we want a random ID for private path
            setUserId(crypto.randomUUID()); 
          }
          setIsAuthReady(true);
        }
      });
      return () => unsubscribeAuth();
    } catch (e) {
      console.error("Firebase initialization failed:", e);
      setIsAuthReady(true);
      setIsLoading(false);
    }
  }, []);

  // 2. Real-time Data Fetching (onSnapshot)
  useEffect(() => {
    if (!db || !isAuthReady || !userId) return;

    const collectionPath = `/artifacts/${appId}/users/${userId}/transactions`;
    const q = query(collection(db, collectionPath));
    
    // Attaching the real-time listener
    const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
      const fetchedTransactions = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Ensure date is a string for consistent memoization and sorting
        date: doc.data().date instanceof Date ? doc.data().date.toISOString().substring(0, 10) : doc.data().date,
      }));
      // Sort by date descending for the list
      fetchedTransactions.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      
      setTransactions(fetchedTransactions);
      setIsLoading(false);
    }, (error) => {
      console.error("Error fetching transactions:", error);
      setIsLoading(false);
    });

    return () => unsubscribeSnapshot();
  }, [db, isAuthReady, userId]);

  // 3. Data Aggregation (Monthly Ledger & Breakdown)
  const { totalBalance, totalIncome, totalExpenses, expenseBreakdown, monthlyFlow } = useMemo(() => {
    const monthlySummary = {};
    const expenseCategories = {};
    let totalIncome = 0;
    let totalExpenses = 0;

    if (!transactions.length) {
        return { totalBalance: 0, totalIncome: 0, totalExpenses: 0, expenseBreakdown: [], monthlyFlow: [] };
    }

    const getMonthYearKey = (dateString) => dateString ? dateString.substring(0, 7) : 'Unknown';
    const getShortMonthName = (dateString) => new Date(dateString).toLocaleString('en-US', { month: 'short' });

    transactions.forEach(t => {
      const monthKey = getMonthYearKey(t.date);

      // 1. Calculate Monthly Summary (Bar Chart Data)
      if (!monthlySummary[monthKey]) {
        monthlySummary[monthKey] = { income: 0, expense: 0, month: getShortMonthName(t.date), sortKey: monthKey };
      }

      if (t.type === 'Income') {
        monthlySummary[monthKey].income += t.amount;
        totalIncome += t.amount;
      } else {
        monthlySummary[monthKey].expense += t.amount;
        totalExpenses += t.amount;

        // 2. Calculate Expense Breakdown (Pie Chart Data - All Time)
        expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
      }
    });

    // Format and sort monthly flow data
    const monthlyFlowData = Object.values(monthlySummary).map(item => ({
        month: item.month,
        income: item.income,
        expense: item.expense,
        sortKey: item.sortKey,
    }));
    // Sort chronologically by YYYY-MM key
    monthlyFlowData.sort((a, b) => (a.sortKey > b.sortKey) ? 1 : -1);


    // Format expense breakdown data
    const breakdown = Object.keys(expenseCategories).map(category => ({
      name: category,
      value: expenseCategories[category],
    })).filter(item => item.value > 0); // Only include categories with value

    return {
      totalBalance: totalIncome - totalExpenses,
      totalIncome,
      totalExpenses,
      expenseBreakdown: breakdown,
      monthlyFlow: monthlyFlowData,
    };
  }, [transactions]);


  // Custom scrollbar style for dark mode
  useEffect(() => {
    const style = document.createElement('style');
    style.innerHTML = `
      .custom-scrollbar::-webkit-scrollbar { width: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #1F2937; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4B5563; }
    `;
    document.head.appendChild(style);
    return () => { document.head.removeChild(style); };
  }, []);

  return (
    <div className="min-h-screen bg-gray-900 font-sans p-4 sm:p-8 relative">
      <header className="mb-8 border-b border-gray-700/50 pb-4 flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-extrabold text-indigo-400 flex items-center">
            <Home className="w-7 h-7 mr-3" />
            Financial Ledger Dashboard
          </h1>
          <p className="text-gray-400 mt-1 text-sm">Minimalist dark mode for real-time tracking.</p>
        </div>
        <button
          onClick={() => setShowModal(true)}
          disabled={!db || !userId}
          className="flex items-center bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <Plus className="w-5 h-5 mr-2" />
          Add Transaction
        </button>
      </header>
      
      {/* Show User ID for collaboration/debugging */}
      {userId && (
        <p className="text-sm text-gray-500 mb-4 truncate">
            User ID: <span className="text-gray-400 font-mono">{userId}</span>
        </p>
      )}

      {/* Stats Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <StatsCard 
          title="Total Balance" 
          value={totalBalance} 
          icon={DollarSign} 
          colorClass={totalBalance >= 0 ? 'text-indigo-400' : 'text-red-400'}
        />
        <StatsCard 
          title="Total Income" 
          value={totalIncome} 
          icon={TrendingUp} 
          colorClass="text-green-400"
        />
        <StatsCard 
          title="Total Expenses" 
          value={totalExpenses} 
          icon={TrendingDown} 
          colorClass="text-red-400"
        />
      </div>

      {/* Main Content: Charts & Transactions */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* Monthly Cash Flow Bar Chart (2/3 width on desktop) */}
        <BarChartComponent data={monthlyFlow} />

        {/* Expense Breakdown Pie Chart (1/3 width on desktop) */}
        <PieChartComponent data={expenseBreakdown} />

        {/* Recent Transactions List (Full width row below charts) */}
        <div className="lg:col-span-3">
          <TransactionList transactions={transactions} isLoading={isLoading} />
        </div>
      </div>

      <footer className="mt-10 text-center text-sm text-gray-600 border-t border-gray-700/50 pt-4">
        Data is saved securely to your private Firestore ledger.
      </footer>
      
      <AddTransactionModal 
        isVisible={showModal} 
        onClose={() => setShowModal(false)} 
        db={db} 
        userId={userId} 
      />
    </div>
  );
};

export default App;
